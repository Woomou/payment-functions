<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Payment Test</title>
    <!-- PayPal JavaScript SDK will be loaded dynamically -->
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .product {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            background: #fafafa;
        }
        .product h3 {
            margin-top: 0;
            color: #0070ba;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #0070ba;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #005ea6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }
        .config h3 {
            margin-top: 0;
            color: #856404;
        }
        .config code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .nav-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .nav-button:hover {
            background: #138496;
        }
        .nav-button.active {
            background: #28a745;
        }
        .test-section {
            display: none;
            margin-top: 20px;
        }
        .test-section.active {
            display: block;
        }
        .test-row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .test-col {
            flex: 1;
        }
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .api-form h4 {
            margin-top: 0;
            color: #495057;
        }
        .json-input {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .response-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-button.active {
            background: #007bff;
        }
        .order-id-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
        .card-field {
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 12px;
            margin: 8px 0;
            background: white;
            min-height: 44px;
            display: flex;
            align-items: center;
        }
        .card-field.invalid {
            border-color: #dc3545;
            background-color: #f8d7da;
        }
        .card-field.valid {
            border-color: #28a745;
            background-color: #d4edda;
        }
        .submit-button {
            background: #007bff;
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 10px;
        }
        .submit-button:hover {
            background: #0056b3;
        }
        .submit-button:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        .payment-section {
            border: 2px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin: 20px 0;
            background: #f8f9fa;
        }
        .payment-section.active {
            border-color: #007bff;
            background: #e7f3ff;
        }
        .card-field-group {
            margin: 15px 0;
        }
        .card-field-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
            font-size: 14px;
        }
        .card-field-input {
            border: 2px solid #ddd;
            border-radius: 6px;
            padding: 12px;
            margin: 8px 0;
            background: white;
            min-height: 48px;
            display: flex;
            align-items: center;
            transition: border-color 0.3s ease;
            font-size: 16px;
        }
        .card-field-input:hover {
            border-color: #007bff;
        }
        .card-field-input.focus {
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        .card-field-input.invalid {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        .card-field-input.valid {
            border-color: #28a745;
            background-color: #f8fff8;
        }
        #card-fields-container {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 20px;
            margin-top: 20px;
        }
        #card-fields-container h4 {
            color: #0070ba;
            margin-top: 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PayPal All-in-One Test Suite</h1>
        
        <div class="config">
            <h3>üìã Configuration</h3>
            <p>Current API Endpoint: <code id="api-endpoint">https://paypal-payments-development.realharryscissors.workers.dev</code></p>
            <p>Environment: <strong>Development (Sandbox)</strong></p>
            <p>‚ö†Ô∏è Make sure to set the following environment variables in Cloudflare Dashboard:</p>
            <ul>
                <li><code>PAYPAL_CLIENT_ID</code> - Your sandbox PayPal client ID</li>
                <li><code>PAYPAL_CLIENT_SECRET</code> - Your sandbox PayPal client secret</li>
                <li><code>PAYPAL_ENVIRONMENT</code> - "development"</li>
                <li><code>PAYPAL_WEBHOOK_ID</code> - Your webhook ID</li>
            </ul>
            <p>üß™ <strong>Test Credit Card Numbers:</strong></p>
            <ul>
                <li>Visa: <code>4111111111111111</code></li>
                <li>MasterCard: <code>5555555555554444</code></li>
                <li>American Express: <code>371449635398431</code></li>
                <li>CVV: <code>123</code> (Êàñ <code>1234</code> for AmEx)</li>
                <li>Expiry: Any future date (e.g., <code>12/25</code>)</li>
            </ul>
        </div>

        <!-- Test Environment Selector -->
        <div class="config">
            <h3>üéØ Test Environment</h3>
            <label>
                <input type="radio" name="environment" value="development" checked onclick="switchEnvironment('development')">
                Development (Sandbox)
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" name="environment" value="production" onclick="switchEnvironment('production')">
                Production (Live)
            </label>
        </div>

        <!-- Test Navigation -->
        <div class="config">
            <h3>üß™ Test Sections</h3>
            <button onclick="showSection('basic-payment')" class="nav-button">Basic Payment</button>
            <button onclick="showSection('advanced-checkout')" class="nav-button">Advanced Checkout</button>
            <button onclick="showSection('order-tracking')" class="nav-button">Order Tracking</button>
            <button onclick="showSection('payment-management')" class="nav-button">Payment Management</button>
            <button onclick="showSection('webhook-tests')" class="nav-button">Webhook Tests</button>
            <button onclick="showSection('api-explorer')" class="nav-button">API Explorer</button>
        </div>

        <!-- Basic Payment Section -->
        <div id="basic-payment" class="test-section active">
            <div class="product">
                <h3>üõçÔ∏è Basic Payment Test</h3>
                <p>Test basic PayPal payment functionality with SDK integration.</p>
                <div class="price">$<span id="price">10.00</span></div>
                
                <div class="input-group">
                    <label for="amount">Amount (USD):</label>
                    <input type="number" id="amount" value="10.00" min="1" step="0.01">
                </div>
                
                <div class="input-group">
                    <label for="currency">Currency:</label>
                    <select id="currency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" value="Test Payment">
                </div>
                
                <!-- PayPal Buttons Container -->
                <div id="paypal-button-container"></div>
                
                <!-- Card Fields Container -->
                <div id="card-fields-container" style="margin-top: 20px; display: none;">
                    <h4>üí≥ Pay with Credit Card - Advanced Checkout</h4>
                    <p style="color: #666; font-size: 14px; margin-bottom: 15px;">
                        Enter your credit card information directly below. All information is securely processed by PayPal.
                    </p>
                    
                    <div class="card-field-group">
                        <label for="card-name-field-container">Cardholder Name:</label>
                        <div id="card-name-field-container" class="card-field-input"></div>
                    </div>
                    
                    <div class="card-field-group">
                        <label for="card-number-field-container">Card Number:</label>
                        <div id="card-number-field-container" class="card-field-input"></div>
                    </div>
                    
                    <div class="test-row">
                        <div class="test-col">
                            <div class="card-field-group">
                                <label for="card-expiry-field-container">Expiration Date:</label>
                                <div id="card-expiry-field-container" class="card-field-input"></div>
                            </div>
                        </div>
                        <div class="test-col">
                            <div class="card-field-group">
                                <label for="card-cvv-field-container">Security Code (CVV):</label>
                                <div id="card-cvv-field-container" class="card-field-input"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button id="card-field-submit-button" class="submit-button" style="margin-top: 15px;">
                        üîí Submit Card Payment
                    </button>
                    
                    <div style="font-size: 12px; color: #888; margin-top: 10px; text-align: center;">
                        üõ°Ô∏è Your payment information is encrypted and securely processed by PayPal
                    </div>
                </div>
                
                <!-- Manual test buttons -->
                <div class="api-form">
                    <h4>üîß Manual API Testing</h4>
                    <button id="pay-button" onclick="createPayPalOrder()">
                        üí≥ Create PayPal Order (Manual)
                    </button>
                </div>
            </div>
        </div>

        <!-- Advanced Checkout Section -->
        <div id="advanced-checkout" class="test-section">
            <div class="product">
                <h3>üöÄ Advanced Checkout - Direct Card Payment</h3>
                <p>PayPal Advanced Checkout enables direct card payments without redirecting to PayPal.</p>
                
                <div class="test-row">
                    <div class="test-col">
                        <div class="api-form">
                            <h4>üí≥ Payment Details</h4>
                            <div class="input-group">
                                <label for="advanced-amount">Amount (USD):</label>
                                <input type="number" id="advanced-amount" value="25.00" min="1" step="0.01">
                            </div>
                            
                            <div class="input-group">
                                <label for="advanced-currency">Currency:</label>
                                <select id="advanced-currency">
                                    <option value="USD">USD</option>
                                    <option value="EUR">EUR</option>
                                    <option value="GBP">GBP</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label for="advanced-description">Description:</label>
                                <input type="text" id="advanced-description" value="Advanced Checkout Test">
                            </div>
                            
                            <div class="input-group">
                                <label>
                                    <input type="checkbox" id="collect-billing-address" checked>
                                    Collect Billing Address
                                </label>
                            </div>
                            
                            <div class="input-group">
                                <label>
                                    <input type="checkbox" id="collect-shipping-address">
                                    Collect Shipping Address
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="test-col">
                        <div class="api-form">
                            <h4>üé® Card Field Styling</h4>
                            <div class="input-group">
                                <label for="field-color">Text Color:</label>
                                <input type="color" id="field-color" value="#000000">
                            </div>
                            
                            <div class="input-group">
                                <label for="field-font-size">Font Size:</label>
                                <select id="field-font-size">
                                    <option value="14px">14px</option>
                                    <option value="16px" selected>16px</option>
                                    <option value="18px">18px</option>
                                </select>
                            </div>
                            
                            <div class="input-group">
                                <label for="field-border-radius">Border Radius:</label>
                                <select id="field-border-radius">
                                    <option value="0px">0px</option>
                                    <option value="4px" selected>4px</option>
                                    <option value="8px">8px</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Advanced Card Fields -->
                <div class="api-form">
                    <h4>üí≥ Advanced Card Fields</h4>
                    
                    <!-- Debug controls -->
                    <div class="api-form" style="background: #fff3cd; border: 1px solid #ffeaa7;">
                        <h5>üîß Debug Controls</h5>
                        <button onclick="initializeAdvancedCheckout()" style="background: #17a2b8; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">
                            üîÑ Reinitialize Advanced Checkout
                        </button>
                        <button onclick="console.log('PayPal object:', paypal); console.log('CardFields available:', !!paypal.CardFields);" style="background: #6c757d; color: white; border: none; padding: 8px 16px; border-radius: 4px; margin: 5px;">
                            üîç Debug PayPal Object
                        </button>
                    </div>
                    
                    <div id="advanced-card-eligibility" class="status info" style="display: none;">
                        Checking card fields eligibility...
                    </div>
                    
                    <div id="advanced-card-fields-container" style="display: none;">
                        <div class="test-row">
                            <div class="test-col">
                                <label>Cardholder Name:</label>
                                <div id="advanced-card-name-field" class="card-field"></div>
                            </div>
                            <div class="test-col">
                                <label>Card Number:</label>
                                <div id="advanced-card-number-field" class="card-field"></div>
                            </div>
                        </div>
                        
                        <div class="test-row">
                            <div class="test-col">
                                <label>Expiration Date:</label>
                                <div id="advanced-card-expiry-field" class="card-field"></div>
                            </div>
                            <div class="test-col">
                                <label>Security Code:</label>
                                <div id="advanced-card-cvv-field" class="card-field"></div>
                            </div>
                        </div>
                        
                        <div id="billing-address-section" style="display: none;">
                            <h5>üìç Billing Address</h5>
                            <div class="test-row">
                                <div class="test-col">
                                    <label>Street Address:</label>
                                    <div id="advanced-card-billing-address-field" class="card-field"></div>
                                </div>
                                <div class="test-col">
                                    <label>City:</label>
                                    <div id="advanced-card-billing-city-field" class="card-field"></div>
                                </div>
                            </div>
                            <div class="test-row">
                                <div class="test-col">
                                    <label>State/Province:</label>
                                    <div id="advanced-card-billing-state-field" class="card-field"></div>
                                </div>
                                <div class="test-col">
                                    <label>ZIP/Postal Code:</label>
                                    <div id="advanced-card-billing-zip-field" class="card-field"></div>
                                </div>
                            </div>
                            <div class="test-row">
                                <div class="test-col">
                                    <label>Country:</label>
                                    <div id="advanced-card-billing-country-field" class="card-field"></div>
                                </div>
                                <div class="test-col"></div>
                            </div>
                        </div>
                        
                        <button id="advanced-card-submit" class="submit-button" style="margin-top: 20px;">
                            üöÄ Process Advanced Payment
                        </button>
                    </div>
                    
                    <div id="advanced-card-not-eligible" class="status error" style="display: none;">
                        Advanced Card Fields are not eligible for this merchant account.
                    </div>
                </div>
                
                <!-- 3D Secure Section -->
                <div class="api-form">
                    <h4>üîí 3D Secure Authentication</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="enable-3d-secure" checked>
                            Enable 3D Secure Authentication
                        </label>
                    </div>
                    <div class="status info">
                        3D Secure provides additional security for card transactions and is recommended for all payments.
                    </div>
                </div>
                
                <!-- Alternative Payment Methods -->
                <div class="api-form">
                    <h4>üîÑ Alternative Payment Methods</h4>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="enable-paypal-button" checked>
                            Show PayPal Button
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="enable-apple-pay">
                            Enable Apple Pay (if supported)
                        </label>
                    </div>
                    <div class="input-group">
                        <label>
                            <input type="checkbox" id="enable-google-pay">
                            Enable Google Pay (if supported)
                        </label>
                    </div>
                    
                    <div id="alternative-payment-container" style="margin-top: 20px;">
                        <!-- Alternative payment buttons will be rendered here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Tracking Section -->
        <div id="order-tracking" class="test-section">
            <div class="product">
                <h3>üì¶ Order Tracking Tests</h3>
                <p>Test order tracking, shipment tracking, and order management features.</p>
                
                <div class="api-form">
                    <h4>üîç Get Order Details</h4>
                    <input type="text" id="order-id-details" placeholder="Enter Order ID" class="order-id-input">
                    <button onclick="getOrderDetails()">Get Order Details</button>
                    <div id="order-details-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üöö Add Tracking Information</h4>
                    <input type="text" id="order-id-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <textarea id="tracking-data" class="json-input" placeholder='{"tracking_number": "1Z999AA1234567890", "carrier": "UPS", "tracking_url": "https://www.ups.com/track?tracknum=1Z999AA1234567890", "notify_buyer": true}'></textarea>
                    <button onclick="addOrderTracking()">Add Tracking Info</button>
                    <div id="tracking-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìã Get Tracking Information</h4>
                    <input type="text" id="order-id-get-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <button onclick="getOrderTracking()">Get Tracking Info</button>
                    <div id="get-tracking-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìù Update Tracking Information</h4>
                    <input type="text" id="order-id-update-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <textarea id="update-tracking-data" class="json-input" placeholder='{"tracking_number": "1Z999AA1234567890", "carrier": "UPS", "status": "DELIVERED", "tracking_url": "https://www.ups.com/track?tracknum=1Z999AA1234567890", "notify_buyer": true}'></textarea>
                    <button onclick="updateOrderTracking()">Update Tracking Info</button>
                    <div id="update-tracking-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- Payment Management Section -->
        <div id="payment-management" class="test-section">
            <div class="product">
                <h3>üí∞ Payment Management Tests</h3>
                <p>Test payment details retrieval, refund processing, and payment monitoring.</p>
                
                <div class="api-form">
                    <h4>üîç Get Payment Details</h4>
                    <input type="text" id="payment-id-details" placeholder="Enter Payment ID" class="order-id-input">
                    <button onclick="getPaymentDetails()">Get Payment Details</button>
                    <div id="payment-details-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üí∏ Process Refund</h4>
                    <input type="text" id="payment-id-refund" placeholder="Enter Payment ID" class="order-id-input">
                    <textarea id="refund-data" class="json-input" placeholder='{"amount": "10.00", "currency": "USD", "note_to_payer": "Refund for order cancellation", "invoice_id": "INV-123"}'></textarea>
                    <button onclick="processRefund()">Process Refund</button>
                    <div id="refund-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- Webhook Tests Section -->
        <div id="webhook-tests" class="test-section">
            <div class="product">
                <h3>üîî Webhook Tests</h3>
                <p>Test webhook event handling and verification.</p>
                
                <div class="api-form">
                    <h4>‚úÖ Verify Webhook Signature</h4>
                    <textarea id="webhook-verification-data" class="json-input" placeholder='{"auth_algo": "SHA256withRSA", "cert_id": "cert_id", "transmission_id": "transmission_id", "transmission_sig": "signature", "transmission_time": "timestamp", "webhook_id": "webhook_id", "webhook_event": {}}'></textarea>
                    <button onclick="verifyWebhook()">Verify Webhook</button>
                    <div id="webhook-verify-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üß™ Simulate Webhook Events</h4>
                    <select id="webhook-event-type">
                        <option value="CHECKOUT.ORDER.APPROVED">CHECKOUT.ORDER.APPROVED</option>
                        <option value="CHECKOUT.ORDER.COMPLETED">CHECKOUT.ORDER.COMPLETED</option>
                        <option value="PAYMENT.CAPTURE.COMPLETED">PAYMENT.CAPTURE.COMPLETED</option>
                        <option value="PAYMENT.CAPTURE.DENIED">PAYMENT.CAPTURE.DENIED</option>
                        <option value="PAYMENT.CAPTURE.PENDING">PAYMENT.CAPTURE.PENDING</option>
                        <option value="PAYMENT.CAPTURE.REFUNDED">PAYMENT.CAPTURE.REFUNDED</option>
                        <option value="CUSTOMER.DISPUTE.CREATED">CUSTOMER.DISPUTE.CREATED</option>
                    </select>
                    <textarea id="webhook-event-data" class="json-input" placeholder='{"event_type": "PAYMENT.CAPTURE.COMPLETED", "resource": {"id": "payment_id", "amount": {"value": "10.00", "currency_code": "USD"}, "status": "COMPLETED"}}'></textarea>
                    <button onclick="simulateWebhookEvent()">Simulate Event</button>
                    <div id="webhook-simulate-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- API Explorer Section -->
        <div id="api-explorer" class="test-section">
            <div class="product">
                <h3>üîß API Explorer</h3>
                <p>Test any API endpoint with custom parameters.</p>
                
                <div class="api-form">
                    <h4>üöÄ Custom API Call</h4>
                    <select id="api-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <input type="text" id="api-endpoint-input" placeholder="Enter endpoint (e.g., /orders/ORDER_ID)" class="order-id-input">
                    <textarea id="api-body" class="json-input" placeholder='{"key": "value"}'></textarea>
                    <button onclick="makeCustomAPICall()">Make API Call</button>
                    <div id="api-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìä API Status Check</h4>
                    <button onclick="checkAPIStatus()">Check API Status</button>
                    <div id="api-status-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
        
        <div id="order-details" style="display: none;">
            <h3>üìÑ Order Details</h3>
            <pre id="order-json"></pre>
        </div>
    </div>

    <script>
        let API_BASE = 'https://paypal-payments-development.realharryscissors.workers.dev';
        let currentSection = 'basic-payment';

        // Function to dynamically load PayPal SDK
        function loadPayPalSDK(currency = 'USD') {
            showStatus(`Loading PayPal SDK for ${currency}...`, 'info');

            // Remove existing script to avoid conflicts
            const existingScript = document.querySelector('script[src*="paypal.com/sdk/js"]');
            if (existingScript) {
                document.head.removeChild(existingScript);
            }

            // It's good practice to nullify the paypal object to ensure clean reload
            if (window.paypal) {
                window.paypal = null;
            }

            const script = document.createElement('script');
            const clientId = "AcbqkofakNw-zIq4Jql1WkcU0qSi6qfRA3GayhHQ7Ugrz7Bw7fZdyQL_877QUy_gS4LBolWe-HtKbKRl";
            script.src = `https://www.paypal.com/sdk/js?client-id=${clientId}&components=buttons,card-fields,hosted-fields&currency=${currency}&intent=capture&buyer-country=US&debug=true`;
            
            script.onload = () => {
                console.log(`PayPal SDK loaded for ${currency}`);
                if (typeof paypal !== 'undefined') {
                    // Re-initialize all components that depend on the PayPal SDK
                    initializePayPalButtons();
                    initializeCardFields();
                    initializeAdvancedCheckout();
                    showStatus(`PayPal SDK loaded for ${currency}`, 'success');
                } else {
                    showStatus('PayPal SDK failed to load.', 'error');
                }
            };
            
            script.onerror = () => {
                showStatus(`Failed to load PayPal SDK for ${currency}.`, 'error');
            };

            document.head.appendChild(script);
        }
        
        // Environment switching
        function switchEnvironment(env) {
            if (env === 'production') {
                API_BASE = 'https://paypal-payments-production.realharryscissors.workers.dev';
            } else {
                API_BASE = 'https://paypal-payments-development.realharryscissors.workers.dev';
            }
            document.getElementById('api-endpoint').textContent = API_BASE;
            showStatus(`Switched to ${env} environment`, 'info');
        }
        
        // Section navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.test-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            currentSection = sectionId;
        }
        
        // Test API connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();
                console.log('API Status:', data);
                
                if (data.service && data.environment) {
                    showStatus(`‚úÖ API Connected - Environment: ${data.environment}`, 'success');
                } else {
                    showStatus('‚ö†Ô∏è API Connected but unexpected response format', 'error');
                }
            } catch (error) {
                console.error('API Connection Error:', error);
                showStatus(`‚ùå API Connection Failed: ${error.message}`, 'error');
            }
        });
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function updatePrice() {
            const amount = document.getElementById('amount').value;
            document.getElementById('price').textContent = parseFloat(amount).toFixed(2);
        }
        
        document.getElementById('amount').addEventListener('input', updatePrice);
        
        async function createPayPalOrder() {
            const payButton = document.getElementById('pay-button');
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const description = document.getElementById('description').value;
            
            if (!amount || amount <= 0) {
                showStatus('Please enter a valid amount', 'error');
                return;
            }
            
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            hideStatus();
            
            try {
                showStatus('Creating PayPal order...', 'info');
                
                const response = await fetch(`${API_BASE}/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency: currency,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.links) {
                    showStatus('Order created successfully! Redirecting to PayPal...', 'success');
                    
                    // Show order details
                    document.getElementById('order-details').style.display = 'block';
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Find the approval URL
                    const approvalUrl = data.links.find(link => link.rel === 'approve');
                    if (approvalUrl) {
                        // Open PayPal approval page
                        window.open(approvalUrl.href, '_blank');
                        
                        // Show capture button
                        showCaptureButton(data.id);
                    } else {
                        showStatus('No approval URL found in response', 'error');
                    }
                } else {
                    showStatus(`Error: ${data.error || 'Failed to create order'}`, 'error');
                    console.error('PayPal order creation failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error creating PayPal order:', error);
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'üí≥ Pay with PayPal';
            }
        }
        
        function showCaptureButton(orderId) {
            const existingButton = document.getElementById('capture-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            const captureButton = document.createElement('button');
            captureButton.id = 'capture-button';
            captureButton.innerHTML = '‚úÖ Capture Payment';
            captureButton.onclick = () => capturePayPalOrder(orderId);
            captureButton.style.backgroundColor = '#28a745';
            captureButton.style.marginTop = '10px';
            
            document.querySelector('.product').appendChild(captureButton);
        }
        
        async function capturePayPalOrder(orderId) {
            const captureButton = document.getElementById('capture-button');
            captureButton.disabled = true;
            captureButton.textContent = 'Capturing...';
            
            try {
                showStatus('Capturing PayPal payment...', 'info');
                
                const response = await fetch(`${API_BASE}/capture-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderID: orderId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'COMPLETED') {
                    showStatus('Payment captured successfully! üéâ', 'success');
                    
                    // Update order details
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Remove capture button
                    captureButton.remove();
                } else {
                    showStatus(`Capture failed: ${data.error || 'Unknown error'}`, 'error');
                    console.error('PayPal capture failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error capturing PayPal payment:', error);
            } finally {
                captureButton.disabled = false;
                captureButton.textContent = '‚úÖ Capture Payment';
            }
        }
        
        // Global variables
        let cardFields;
        let orderID;
        
        // Initialize PayPal Buttons
        function initializePayPalButtons() {
            // Clear existing buttons
            document.getElementById('paypal-button-container').innerHTML = '';
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const amount = document.getElementById('amount').value;
                    const currency = document.getElementById('currency').value;
                    const description = document.getElementById('description').value;
                    
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    showStatus('Creating PayPal order...', 'info');
                    
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: amount,
                                currency_code: currency
                            },
                            description: description
                        }]
                    });
                },
                
                onApprove: function(data, actions) {
                    showStatus('Payment approved! Capturing...', 'info');
                    
                    return actions.order.capture().then(function(details) {
                        showStatus('Payment completed successfully! üéâ', 'success');
                        
                        // Show order details
                        document.getElementById('order-details').style.display = 'block';
                        document.getElementById('order-json').textContent = JSON.stringify(details, null, 2);
                        
                        console.log('Payment completed:', details);
                        
                        // Also call our backend to record the transaction
                        recordTransaction(details);
                    });
                },
                
                onError: function(err) {
                    showStatus('Payment failed: ' + err.message, 'error');
                    console.error('PayPal error:', err);
                },
                
                onCancel: function(data) {
                    showStatus('Payment cancelled by user', 'error');
                    console.log('Payment cancelled:', data);
                }
            }).render('#paypal-button-container');
        }
        
        // Initialize Card Fields
        function initializeCardFields() {
            if (!paypal.CardFields) {
                showStatus('CardFields component not available', 'error');
                document.getElementById('card-fields-container').style.display = 'none';
                return;
            }
            
            // Check if eligible for CardFields
            if (!paypal.CardFields.isEligible()) {
                showStatus('CardFields not eligible for this merchant account. Using alternative payment methods.', 'info');
                document.getElementById('card-fields-container').style.display = 'none';
                return;
            }
            
            // Show card fields container
            document.getElementById('card-fields-container').style.display = 'block';
            showStatus('CardFields component is eligible - initializing credit card fields...', 'success');
            
            try {
                cardFields = paypal.CardFields({
                    createOrder: function() {
                        const amount = document.getElementById('amount').value;
                        const currency = document.getElementById('currency').value;
                        const description = document.getElementById('description').value;
                        
                        if (!amount || amount <= 0) {
                            showStatus('Please enter a valid amount', 'error');
                            throw new Error('Invalid amount');
                        }
                        
                        showStatus('Creating order for card payment...', 'info');
                        
                        return fetch(`${API_BASE}/create-order`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                amount: parseFloat(amount),
                                currency: currency,
                                description: description
                            })
                        })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Failed to create order');
                            }
                            return response.json();
                        })
                        .then(function(orderData) {
                            console.log('Order created for card payment:', orderData);
                            orderID = orderData.id;
                            return orderData.id;
                        })
                        .catch(function(error) {
                            showStatus('Order creation failed: ' + error.message, 'error');
                            throw error;
                        });
                    },
                    
                    onApprove: function(data) {
                        showStatus('Card payment approved! Capturing...', 'info');
                        
                        return fetch(`${API_BASE}/capture-order`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify({
                                orderID: data.orderID
                            })
                        })
                        .then(function(response) {
                            if (!response.ok) {
                                throw new Error('Failed to capture payment');
                            }
                            return response.json();
                        })
                        .then(function(orderData) {
                            showStatus('Card payment completed successfully! üéâ', 'success');
                            
                            // Show order details
                            document.getElementById('order-details').style.display = 'block';
                            document.getElementById('order-json').textContent = JSON.stringify(orderData, null, 2);
                            
                            console.log('Card payment completed:', orderData);
                            
                            // Record transaction
                            recordTransaction(orderData);
                            
                            return orderData;
                        })
                        .catch(function(error) {
                            showStatus('Payment capture failed: ' + error.message, 'error');
                            throw error;
                        });
                    },
                    
                    onError: function(err) {
                        showStatus('Card payment error: ' + err.message, 'error');
                        console.error('CardFields error:', err);
                    },
                    
                    style: {
                        'input': {
                            'font-size': '16px',
                            'color': '#333',
                            'font-family': 'Arial, sans-serif'
                        }
                    }
                });
                
                // Clear any existing fields first
                document.getElementById('card-name-field-container').innerHTML = '';
                document.getElementById('card-number-field-container').innerHTML = '';
                document.getElementById('card-expiry-field-container').innerHTML = '';
                document.getElementById('card-cvv-field-container').innerHTML = '';
                
                // Render card fields with error handling
                const renderField = (field, container, fieldName) => {
                    try {
                        if (field) {
                            field.render(container);
                            console.log(`${fieldName} field rendered successfully`);
                        } else {
                            console.warn(`${fieldName} field not available`);
                        }
                    } catch (error) {
                        console.error(`Error rendering ${fieldName} field:`, error);
                    }
                };
                
                renderField(cardFields.NameField(), '#card-name-field-container', 'Name');
                renderField(cardFields.NumberField(), '#card-number-field-container', 'Number');
                renderField(cardFields.ExpiryField(), '#card-expiry-field-container', 'Expiry');
                renderField(cardFields.CVVField(), '#card-cvv-field-container', 'CVV');
                
                // Set up submit button (remove existing listeners first)
                const submitButton = document.getElementById('card-field-submit-button');
                const newSubmitButton = submitButton.cloneNode(true);
                submitButton.parentNode.replaceChild(newSubmitButton, submitButton);
                
                newSubmitButton.addEventListener('click', function() {
                    const amount = document.getElementById('amount').value;
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount before submitting', 'error');
                        return;
                    }
                    
                    showStatus('Processing card payment...', 'info');
                    newSubmitButton.disabled = true;
                    newSubmitButton.textContent = 'Processing...';
                    
                    cardFields.submit().then(function() {
                        showStatus('Card payment submitted successfully', 'success');
                    }).catch(function(err) {
                        showStatus('Card payment failed: ' + err.message, 'error');
                        console.error('Card submit error:', err);
                    }).finally(function() {
                        newSubmitButton.disabled = false;
                        newSubmitButton.textContent = 'Submit Payment';
                    });
                });
                
                showStatus('Credit card fields initialized successfully', 'success');
                
            } catch (error) {
                showStatus('Failed to initialize card fields: ' + error.message, 'error');
                console.error('CardFields initialization error:', error);
                document.getElementById('card-fields-container').style.display = 'none';
            }
        }
        
        // Record transaction in our backend
        async function recordTransaction(details) {
            try {
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'PAYMENT.CAPTURE.COMPLETED',
                        resource: details
                    })
                });
                
                if (response.ok) {
                    console.log('Transaction recorded successfully');
                } else {
                    console.warn('Failed to record transaction');
                }
            } catch (error) {
                console.warn('Error recording transaction:', error);
            }
        }
        
        // Update buttons when amount or currency changes
        function updatePayPalButtons() {
            updatePrice();
            // We only need to re-render the buttons, not reload the whole SDK
            initializePayPalButtons();
        }
        
        // Update event listeners
        document.getElementById('amount').addEventListener('input', updatePayPalButtons);
        document.getElementById('description').addEventListener('input', updatePayPalButtons);

        // Handle currency changes by reloading the SDK
        document.getElementById('currency').addEventListener('change', () => {
            const currency = document.getElementById('currency').value;
            loadPayPalSDK(currency);
        });
        document.getElementById('advanced-currency').addEventListener('change', () => {
            const currency = document.getElementById('advanced-currency').value;
            loadPayPalSDK(currency);
        });
        
        // Initialize
        updatePrice();
        
        // Initialize PayPal components when page loads
        window.addEventListener('load', () => {
            const initialCurrency = document.getElementById('currency').value || 'USD';
            loadPayPalSDK(initialCurrency);
        });
        
        // ======================
        // NEW TESTING FUNCTIONS
        // ======================
        
        // Order Details Functions
        async function getOrderDetails() {
            const orderId = document.getElementById('order-id-details').value;
            if (!orderId) {
                showStatus('Please enter an Order ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching order details...', 'info');
                const response = await fetch(`${API_BASE}/orders/${orderId}`);
                const data = await response.json();
                
                document.getElementById('order-details-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Order details fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch order details'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        // Order Tracking Functions
        async function getOrderTracking() {
            const orderId = document.getElementById('order-id-get-tracking').value;
            if (!orderId) {
                showStatus('Please enter an Order ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching tracking information...', 'info');
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`);
                const data = await response.json();
                
                document.getElementById('get-tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function addOrderTracking() {
            const orderId = document.getElementById('order-id-tracking').value;
            const trackingData = document.getElementById('tracking-data').value;
            
            if (!orderId || !trackingData) {
                showStatus('Please enter both Order ID and tracking data', 'error');
                return;
            }
            
            try {
                const trackingJson = JSON.parse(trackingData);
                showStatus('Adding tracking information...', 'info');
                
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trackingJson)
                });
                
                const data = await response.json();
                document.getElementById('tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information added successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to add tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function updateOrderTracking() {
            const orderId = document.getElementById('order-id-update-tracking').value;
            const trackingData = document.getElementById('update-tracking-data').value;
            
            if (!orderId || !trackingData) {
                showStatus('Please enter both Order ID and tracking data', 'error');
                return;
            }
            
            try {
                const trackingJson = JSON.parse(trackingData);
                showStatus('Updating tracking information...', 'info');
                
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trackingJson)
                });
                
                const data = await response.json();
                document.getElementById('update-tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information updated successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to update tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Payment Management Functions
        async function getPaymentDetails() {
            const paymentId = document.getElementById('payment-id-details').value;
            if (!paymentId) {
                showStatus('Please enter a Payment ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching payment details...', 'info');
                const response = await fetch(`${API_BASE}/payments/${paymentId}`);
                const data = await response.json();
                
                document.getElementById('payment-details-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Payment details fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch payment details'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function processRefund() {
            const paymentId = document.getElementById('payment-id-refund').value;
            const refundData = document.getElementById('refund-data').value;
            
            if (!paymentId || !refundData) {
                showStatus('Please enter both Payment ID and refund data', 'error');
                return;
            }
            
            try {
                const refundJson = JSON.parse(refundData);
                showStatus('Processing refund...', 'info');
                
                const response = await fetch(`${API_BASE}/payments/${paymentId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(refundJson)
                });
                
                const data = await response.json();
                document.getElementById('refund-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Refund processed successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to process refund'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Webhook Functions
        async function verifyWebhook() {
            const webhookData = document.getElementById('webhook-verification-data').value;
            
            if (!webhookData) {
                showStatus('Please enter webhook verification data', 'error');
                return;
            }
            
            try {
                const webhookJson = JSON.parse(webhookData);
                showStatus('Verifying webhook signature...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(webhookJson)
                });
                
                const data = await response.json();
                document.getElementById('webhook-verify-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Webhook signature verified successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to verify webhook signature'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function simulateWebhookEvent() {
            const eventType = document.getElementById('webhook-event-type').value;
            const eventData = document.getElementById('webhook-event-data').value;
            
            if (!eventData) {
                showStatus('Please enter webhook event data', 'error');
                return;
            }
            
            try {
                const eventJson = JSON.parse(eventData);
                eventJson.event_type = eventType; // Override with selected event type
                
                showStatus('Simulating webhook event...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(eventJson)
                });
                
                const data = await response.text();
                document.getElementById('webhook-simulate-response').textContent = data;
                
                if (response.ok) {
                    showStatus('Webhook event simulated successfully', 'success');
                } else {
                    showStatus(`Error: Failed to simulate webhook event`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // API Explorer Functions
        async function makeCustomAPICall() {
            const method = document.getElementById('api-method').value;
            const endpoint = document.getElementById('api-endpoint-input').value;
            const body = document.getElementById('api-body').value;
            
            if (!endpoint) {
                showStatus('Please enter an API endpoint', 'error');
                return;
            }
            
            try {
                showStatus(`Making ${method} request to ${endpoint}...`, 'info');
                
                const requestOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (method !== 'GET' && body) {
                    requestOptions.body = body;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, requestOptions);
                const data = await response.json();
                
                document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus(`${method} request completed successfully`, 'success');
                } else {
                    showStatus(`Error: ${data.error || 'API request failed'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function checkAPIStatus() {
            try {
                showStatus('Checking API status...', 'info');
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                document.getElementById('api-status-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('API status check completed successfully', 'success');
                } else {
                    showStatus('API status check failed', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // ======================
        // ADVANCED CHECKOUT FUNCTIONS
        // ======================
        
        let advancedCardFields;
        let advancedCardFieldsValid = false;
        
        // Initialize Advanced Checkout
        async function initializeAdvancedCheckout() {
            console.log('Initializing Advanced Checkout...');
            
            if (!paypal || !paypal.CardFields) {
                showAdvancedStatus('PayPal CardFields component not available', 'error');
                document.getElementById('advanced-card-not-eligible').style.display = 'block';
                document.getElementById('advanced-card-not-eligible').textContent = 'PayPal CardFields component not loaded';
                return;
            }
            
            // Fields are eligible, proceed with setup
            document.getElementById('advanced-card-eligibility').textContent = 'Card Fields are eligible! Setting up advanced checkout...';
            document.getElementById('advanced-card-fields-container').style.display = 'block';
            document.getElementById('advanced-card-eligibility').className = 'status success';
            
            try {
                console.log('Setting up advanced card fields...');
                await setupAdvancedCardFields();
                
                console.log('Setting up alternative payments...');
                setupAdvancedAlternativePayments();
                
                console.log('Setting up event listeners...');
                setupAdvancedEventListeners();
                
                // Hide eligibility message and show success
                setTimeout(() => {
                    document.getElementById('advanced-card-eligibility').style.display = 'none';
                }, 2000);
                
                showAdvancedStatus('Advanced Checkout initialized successfully! You can now enter credit card information.', 'success');
                
            } catch (error) {
                console.error('Advanced Checkout initialization error:', error);
                showAdvancedStatus(`Failed to initialize Advanced Checkout: ${error.message}`, 'error');
                document.getElementById('advanced-card-fields-container').style.display = 'none';
            }
        }
        
        // Setup Advanced Card Fields
        async function setupAdvancedCardFields() {
            const collectBilling = document.getElementById('collect-billing-address').checked;
            const collectShipping = document.getElementById('collect-shipping-address').checked;
            
            // Get style configuration
            const style = getAdvancedCardFieldStyle();
            
            advancedCardFields = paypal.CardFields({
                createOrder: function() {
                    return createAdvancedOrder();
                },
                
                onApprove: function(data) {
                    return captureAdvancedOrder(data.orderID);
                },
                
                onError: function(err) {
                    showAdvancedStatus(`Payment error: ${err.message}`, 'error');
                    console.error('Advanced Card Fields error:', err);
                },
                
                style: {
                    'input': style
                }
            });
            
            // Clear existing fields first
            document.getElementById('advanced-card-name-field').innerHTML = '';
            document.getElementById('advanced-card-number-field').innerHTML = '';
            document.getElementById('advanced-card-expiry-field').innerHTML = '';
            document.getElementById('advanced-card-cvv-field').innerHTML = '';
            
            // Render card fields with proper error handling
            try {
                if (advancedCardFields.NameField) {
                    advancedCardFields.NameField().render('#advanced-card-name-field');
                    console.log('Advanced Name field rendered');
                }
                
                if (advancedCardFields.NumberField) {
                    advancedCardFields.NumberField().render('#advanced-card-number-field');
                    console.log('Advanced Number field rendered');
                }
                
                if (advancedCardFields.ExpiryField) {
                    advancedCardFields.ExpiryField().render('#advanced-card-expiry-field');
                    console.log('Advanced Expiry field rendered');
                }
                
                if (advancedCardFields.CVVField) {
                    advancedCardFields.CVVField().render('#advanced-card-cvv-field');
                    console.log('Advanced CVV field rendered');
                }
            } catch (error) {
                console.error('Error rendering advanced card fields:', error);
                showAdvancedStatus('Error rendering card fields: ' + error.message, 'error');
            }
            
            // Render billing address fields if enabled
            if (collectBilling) {
                document.getElementById('billing-address-section').style.display = 'block';
                
                try {
                    // Clear billing fields first
                    ['billing-address', 'billing-city', 'billing-state', 'billing-zip', 'billing-country'].forEach(field => {
                        const element = document.getElementById(`advanced-card-${field}-field`);
                        if (element) element.innerHTML = '';
                    });
                    
                    // Note: Billing address fields may not be available in all PayPal accounts
                    // They require special merchant approval
                    console.log('Billing address collection requested but may require merchant approval');
                    
                } catch (error) {
                    console.error('Error rendering billing address fields:', error);
                }
            } else {
                document.getElementById('billing-address-section').style.display = 'none';
            }
        }
        
        // Get card field styling
        function getAdvancedCardFieldStyle() {
            return {
                'color': document.getElementById('field-color').value,
                'font-size': document.getElementById('field-font-size').value,
                'border-radius': document.getElementById('field-border-radius').value,
                'border': '1px solid #ddd',
                'padding': '12px'
            };
        }
        
        // Create order for advanced checkout
        async function createAdvancedOrder() {
            const amount = document.getElementById('advanced-amount').value;
            const currency = document.getElementById('advanced-currency').value;
            const description = document.getElementById('advanced-description').value;
            
            if (!amount || amount <= 0) {
                showAdvancedStatus('Please enter a valid amount', 'error');
                throw new Error('Invalid amount');
            }
            
            showAdvancedStatus('Creating order for advanced checkout...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency: currency,
                        description: description,
                        advanced_checkout: true,
                        three_d_secure: document.getElementById('enable-3d-secure').checked
                    })
                });
                
                const orderData = await response.json();
                
                if (!response.ok) {
                    throw new Error(orderData.error || 'Failed to create order');
                }
                
                return orderData.id;
                
            } catch (error) {
                showAdvancedStatus(`Order creation failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Capture advanced order
        async function captureAdvancedOrder(orderID) {
            showAdvancedStatus('Processing advanced payment...', 'info');
            
            try {
                const response = await fetch(`${API_BASE}/capture-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderID: orderID
                    })
                });
                
                const captureData = await response.json();
                
                if (!response.ok) {
                    throw new Error(captureData.error || 'Payment capture failed');
                }
                
                showAdvancedStatus('Advanced payment completed successfully! üéâ', 'success');
                
                // Show order details
                document.getElementById('order-details').style.display = 'block';
                document.getElementById('order-json').textContent = JSON.stringify(captureData, null, 2);
                
                return captureData;
                
            } catch (error) {
                showAdvancedStatus(`Payment capture failed: ${error.message}`, 'error');
                throw error;
            }
        }
        
        // Setup alternative payment methods
        function setupAdvancedAlternativePayments() {
            const container = document.getElementById('alternative-payment-container');
            container.innerHTML = '';
            
            if (document.getElementById('enable-paypal-button').checked) {
                const paypalContainer = document.createElement('div');
                paypalContainer.id = 'advanced-paypal-buttons';
                container.appendChild(paypalContainer);
                
                paypal.Buttons({
                    createOrder: function() {
                        return createAdvancedOrder();
                    },
                    onApprove: function(data, actions) {
                        return captureAdvancedOrder(data.orderID);
                    },
                    onError: function(err) {
                        showAdvancedStatus(`PayPal button error: ${err.message}`, 'error');
                    }
                }).render('#advanced-paypal-buttons');
            }
            
            // Add Apple Pay and Google Pay buttons if enabled
            // (These would require additional setup and merchant approval)
        }
        
        // Setup advanced event listeners
        function setupAdvancedEventListeners() {
            // Submit button
            document.getElementById('advanced-card-submit').addEventListener('click', function() {
                showAdvancedStatus('Processing card payment...', 'info');
                
                if (advancedCardFields) {
                    advancedCardFields.submit().then(function() {
                        showAdvancedStatus('Card payment submitted successfully', 'success');
                    }).catch(function(err) {
                        showAdvancedStatus(`Card payment failed: ${err.message}`, 'error');
                    });
                }
            });
            
            // Billing address checkbox
            document.getElementById('collect-billing-address').addEventListener('change', function() {
                if (advancedCardFields) {
                    setupAdvancedCardFields(); // Re-initialize with new settings
                }
            });
            
            // Style changes
            ['field-color', 'field-font-size', 'field-border-radius'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    if (advancedCardFields) {
                        setupAdvancedCardFields(); // Re-initialize with new styles
                    }
                });
            });
            
            // Alternative payment methods
            ['enable-paypal-button', 'enable-apple-pay', 'enable-google-pay'].forEach(id => {
                document.getElementById(id).addEventListener('change', function() {
                    setupAdvancedAlternativePayments();
                });
            });
        }
        
        // Show status for advanced checkout
        function showAdvancedStatus(message, type = 'info') {
            // Use the existing showStatus function
            showStatus(message, type);
            
            // Also log to console for debugging
            console.log(`Advanced Checkout: ${message}`);
        }
        
        // Initialize first nav button as active
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.nav-button').classList.add('active');
        });
    </script>
</body>
</html>