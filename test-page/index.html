<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Payment Test</title>
    <!-- PayPal JavaScript SDK with card-fields component -->
    <script src="https://www.paypal.com/sdk/js?client-id=AcbqkofakNw-zIq4Jql1WkcU0qSi6qfRA3GayhHQ7Ugrz7Bw7fZdyQL_877QUy_gS4LBolWe-HtKbKRl&components=buttons,card-fields&currency=USD&intent=capture"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .product {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            background: #fafafa;
        }
        .product h3 {
            margin-top: 0;
            color: #0070ba;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #0070ba;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #005ea6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }
        .config h3 {
            margin-top: 0;
            color: #856404;
        }
        .config code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PayPal Payment Test</h1>
        
        <div class="config">
            <h3>üìã Configuration</h3>
            <p>Current API Endpoint: <code id="api-endpoint">https://paypal-payments-development.realharryscissors.workers.dev</code></p>
            <p>Environment: <strong>Development (Sandbox)</strong></p>
            <p>‚ö†Ô∏è Make sure to set the following environment variables in Cloudflare Dashboard:</p>
            <ul>
                <li><code>PAYPAL_CLIENT_ID</code> - Your sandbox PayPal client ID</li>
                <li><code>PAYPAL_CLIENT_SECRET</code> - Your sandbox PayPal client secret</li>
                <li><code>PAYPAL_ENVIRONMENT</code> - "development"</li>
            </ul>
            <p>üß™ <strong>Test Credit Card Numbers:</strong></p>
            <ul>
                <li>Visa: <code>4111111111111111</code></li>
                <li>MasterCard: <code>5555555555554444</code></li>
                <li>American Express: <code>371449635398431</code></li>
                <li>CVV: <code>123</code> (Êàñ <code>1234</code> for AmEx)</li>
                <li>Expiry: Any future date (e.g., <code>12/25</code>)</li>
            </ul>
        </div>

        <div class="product">
            <h3>üõçÔ∏è Test Product</h3>
            <p>This is a test product to verify PayPal payment integration.</p>
            <div class="price">$<span id="price">10.00</span></div>
            
            <div class="input-group">
                <label for="amount">Amount (USD):</label>
                <input type="number" id="amount" value="10.00" min="1" step="0.01">
            </div>
            
            <div class="input-group">
                <label for="currency">Currency:</label>
                <select id="currency">
                    <option value="USD">USD</option>
                    <option value="EUR">EUR</option>
                    <option value="GBP">GBP</option>
                </select>
            </div>
            
            <div class="input-group">
                <label for="description">Description:</label>
                <input type="text" id="description" value="Test Payment">
            </div>
            
            <!-- PayPal Buttons Container -->
            <div id="paypal-button-container"></div>
            
            <!-- Card Fields Container -->
            <div id="card-fields-container" style="margin-top: 20px;">
                <h4>üí≥ Pay with Credit Card</h4>
                <div id="card-name-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                <div id="card-number-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                <div id="card-expiry-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                <div id="card-cvv-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                <button id="card-field-submit-button" style="margin-top: 10px; padding: 10px 20px; background: #0070ba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                    Submit Payment
                </button>
            </div>
            
            <!-- Fallback manual buttons -->
            <div id="manual-buttons" style="display: none;">
                <button id="pay-button" onclick="createPayPalOrder()">
                    üí≥ Create PayPal Order (Manual)
                </button>
            </div>
        </div>

        <div id="status" class="status"></div>
        
        <div id="order-details" style="display: none;">
            <h3>üìÑ Order Details</h3>
            <pre id="order-json"></pre>
        </div>
    </div>

    <script>
        const API_BASE = 'https://paypal-payments-development.realharryscissors.workers.dev';
        
        // Test API connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();
                console.log('API Status:', data);
                
                if (data.service && data.environment) {
                    showStatus(`‚úÖ API Connected - Environment: ${data.environment}`, 'success');
                } else {
                    showStatus('‚ö†Ô∏è API Connected but unexpected response format', 'error');
                }
            } catch (error) {
                console.error('API Connection Error:', error);
                showStatus(`‚ùå API Connection Failed: ${error.message}`, 'error');
            }
        });
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function updatePrice() {
            const amount = document.getElementById('amount').value;
            document.getElementById('price').textContent = parseFloat(amount).toFixed(2);
        }
        
        document.getElementById('amount').addEventListener('input', updatePrice);
        
        async function createPayPalOrder() {
            const payButton = document.getElementById('pay-button');
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const description = document.getElementById('description').value;
            
            if (!amount || amount <= 0) {
                showStatus('Please enter a valid amount', 'error');
                return;
            }
            
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            hideStatus();
            
            try {
                showStatus('Creating PayPal order...', 'info');
                
                const response = await fetch(`${API_BASE}/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency: currency,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.links) {
                    showStatus('Order created successfully! Redirecting to PayPal...', 'success');
                    
                    // Show order details
                    document.getElementById('order-details').style.display = 'block';
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Find the approval URL
                    const approvalUrl = data.links.find(link => link.rel === 'approve');
                    if (approvalUrl) {
                        // Open PayPal approval page
                        window.open(approvalUrl.href, '_blank');
                        
                        // Show capture button
                        showCaptureButton(data.id);
                    } else {
                        showStatus('No approval URL found in response', 'error');
                    }
                } else {
                    showStatus(`Error: ${data.error || 'Failed to create order'}`, 'error');
                    console.error('PayPal order creation failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error creating PayPal order:', error);
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'üí≥ Pay with PayPal';
            }
        }
        
        function showCaptureButton(orderId) {
            const existingButton = document.getElementById('capture-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            const captureButton = document.createElement('button');
            captureButton.id = 'capture-button';
            captureButton.innerHTML = '‚úÖ Capture Payment';
            captureButton.onclick = () => capturePayPalOrder(orderId);
            captureButton.style.backgroundColor = '#28a745';
            captureButton.style.marginTop = '10px';
            
            document.querySelector('.product').appendChild(captureButton);
        }
        
        async function capturePayPalOrder(orderId) {
            const captureButton = document.getElementById('capture-button');
            captureButton.disabled = true;
            captureButton.textContent = 'Capturing...';
            
            try {
                showStatus('Capturing PayPal payment...', 'info');
                
                const response = await fetch(`${API_BASE}/capture-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderID: orderId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'COMPLETED') {
                    showStatus('Payment captured successfully! üéâ', 'success');
                    
                    // Update order details
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Remove capture button
                    captureButton.remove();
                } else {
                    showStatus(`Capture failed: ${data.error || 'Unknown error'}`, 'error');
                    console.error('PayPal capture failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error capturing PayPal payment:', error);
            } finally {
                captureButton.disabled = false;
                captureButton.textContent = '‚úÖ Capture Payment';
            }
        }
        
        // Global variables
        let cardFields;
        let orderID;
        
        // Initialize PayPal Buttons
        function initializePayPalButtons() {
            // Clear existing buttons
            document.getElementById('paypal-button-container').innerHTML = '';
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const amount = document.getElementById('amount').value;
                    const currency = document.getElementById('currency').value;
                    const description = document.getElementById('description').value;
                    
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    showStatus('Creating PayPal order...', 'info');
                    
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: amount,
                                currency_code: currency
                            },
                            description: description
                        }]
                    });
                },
                
                onApprove: function(data, actions) {
                    showStatus('Payment approved! Capturing...', 'info');
                    
                    return actions.order.capture().then(function(details) {
                        showStatus('Payment completed successfully! üéâ', 'success');
                        
                        // Show order details
                        document.getElementById('order-details').style.display = 'block';
                        document.getElementById('order-json').textContent = JSON.stringify(details, null, 2);
                        
                        console.log('Payment completed:', details);
                        
                        // Also call our backend to record the transaction
                        recordTransaction(details);
                    });
                },
                
                onError: function(err) {
                    showStatus('Payment failed: ' + err.message, 'error');
                    console.error('PayPal error:', err);
                },
                
                onCancel: function(data) {
                    showStatus('Payment cancelled by user', 'error');
                    console.log('Payment cancelled:', data);
                }
            }).render('#paypal-button-container');
        }
        
        // Initialize Card Fields
        function initializeCardFields() {
            if (!paypal.CardFields) {
                showStatus('CardFields component not available', 'error');
                return;
            }
            
            // Check if eligible for CardFields
            if (!paypal.CardFields.isEligible()) {
                showStatus('CardFields not eligible for this merchant', 'error');
                document.getElementById('card-fields-container').style.display = 'none';
                return;
            }
            
            showStatus('CardFields component is eligible', 'success');
            
            cardFields = paypal.CardFields({
                createOrder: function() {
                    const amount = document.getElementById('amount').value;
                    const currency = document.getElementById('currency').value;
                    const description = document.getElementById('description').value;
                    
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    showStatus('Creating order for card payment...', 'info');
                    
                    return fetch(`${API_BASE}/create-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: parseFloat(amount),
                            currency: currency,
                            description: description
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(orderData) {
                        orderID = orderData.id;
                        return orderData.id;
                    });
                },
                
                onApprove: function(data) {
                    showStatus('Payment approved! Capturing...', 'info');
                    
                    return fetch(`${API_BASE}/capture-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            orderID: data.orderID
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(orderData) {
                        showStatus('Payment completed successfully! üéâ', 'success');
                        
                        // Show order details
                        document.getElementById('order-details').style.display = 'block';
                        document.getElementById('order-json').textContent = JSON.stringify(orderData, null, 2);
                        
                        console.log('Payment completed:', orderData);
                        
                        // Record transaction
                        recordTransaction(orderData);
                    });
                },
                
                onError: function(err) {
                    showStatus('Payment failed: ' + err.message, 'error');
                    console.error('CardFields error:', err);
                }
            });
            
            // Render card fields
            if (cardFields.NameField) {
                cardFields.NameField().render('#card-name-field-container');
            }
            
            if (cardFields.NumberField) {
                cardFields.NumberField().render('#card-number-field-container');
            }
            
            if (cardFields.ExpiryField) {
                cardFields.ExpiryField().render('#card-expiry-field-container');
            }
            
            if (cardFields.CVVField) {
                cardFields.CVVField().render('#card-cvv-field-container');
            }
            
            // Set up submit button
            document.getElementById('card-field-submit-button').addEventListener('click', function() {
                showStatus('Processing card payment...', 'info');
                
                cardFields.submit().then(function() {
                    showStatus('Card payment submitted successfully', 'success');
                }).catch(function(err) {
                    showStatus('Card payment failed: ' + err.message, 'error');
                    console.error('Card submit error:', err);
                });
            });
        }
        
        // Record transaction in our backend
        async function recordTransaction(details) {
            try {
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'PAYMENT.CAPTURE.COMPLETED',
                        resource: details
                    })
                });
                
                if (response.ok) {
                    console.log('Transaction recorded successfully');
                } else {
                    console.warn('Failed to record transaction');
                }
            } catch (error) {
                console.warn('Error recording transaction:', error);
            }
        }
        
        // Update buttons when amount or currency changes
        function updatePayPalButtons() {
            updatePrice();
            initializePayPalButtons();
        }
        
        // Update event listeners
        document.getElementById('amount').addEventListener('input', updatePayPalButtons);
        document.getElementById('currency').addEventListener('change', updatePayPalButtons);
        document.getElementById('description').addEventListener('input', updatePayPalButtons);
        
        // Initialize
        updatePrice();
        
        // Initialize PayPal components when page loads
        window.addEventListener('load', () => {
            // Wait a bit for PayPal SDK to load
            setTimeout(() => {
                if (typeof paypal !== 'undefined') {
                    initializePayPalButtons();
                    initializeCardFields();
                    showStatus('PayPal SDK loaded successfully', 'success');
                } else {
                    showStatus('PayPal SDK failed to load, showing manual buttons', 'error');
                    document.getElementById('manual-buttons').style.display = 'block';
                }
            }, 1000);
        });
    </script>
</body>
</html>