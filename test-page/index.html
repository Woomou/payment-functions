<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal Payment Test</title>
    <!-- PayPal JavaScript SDK with card-fields component -->
    <script src="https://www.paypal.com/sdk/js?client-id=AcbqkofakNw-zIq4Jql1WkcU0qSi6qfRA3GayhHQ7Ugrz7Bw7fZdyQL_877QUy_gS4LBolWe-HtKbKRl&components=buttons,card-fields&currency=USD&intent=capture"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .product {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 20px 0;
            border-radius: 5px;
            background: #fafafa;
        }
        .product h3 {
            margin-top: 0;
            color: #0070ba;
        }
        .price {
            font-size: 24px;
            font-weight: bold;
            color: #333;
            margin: 10px 0;
        }
        .input-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        button {
            background: #0070ba;
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            width: 100%;
            margin-top: 20px;
        }
        button:hover {
            background: #005ea6;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .status {
            padding: 15px;
            margin: 20px 0;
            border-radius: 5px;
            display: none;
        }
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        .config {
            background: #fff3cd;
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ffeaa7;
            margin-bottom: 20px;
        }
        .config h3 {
            margin-top: 0;
            color: #856404;
        }
        .config code {
            background: #f8f9fa;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
        }
        .nav-button {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        .nav-button:hover {
            background: #138496;
        }
        .nav-button.active {
            background: #28a745;
        }
        .test-section {
            display: none;
            margin-top: 20px;
        }
        .test-section.active {
            display: block;
        }
        .test-row {
            display: flex;
            gap: 20px;
            margin: 20px 0;
        }
        .test-col {
            flex: 1;
        }
        .api-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 15px 0;
        }
        .api-form h4 {
            margin-top: 0;
            color: #495057;
        }
        .json-input {
            width: 100%;
            min-height: 100px;
            font-family: 'Courier New', monospace;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
        }
        .response-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 15px;
            margin: 10px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        .tab-button {
            background: #6c757d;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
        }
        .tab-button.active {
            background: #007bff;
        }
        .order-id-input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>PayPal All-in-One Test Suite</h1>
        
        <div class="config">
            <h3>üìã Configuration</h3>
            <p>Current API Endpoint: <code id="api-endpoint">https://paypal-payments-development.realharryscissors.workers.dev</code></p>
            <p>Environment: <strong>Development (Sandbox)</strong></p>
            <p>‚ö†Ô∏è Make sure to set the following environment variables in Cloudflare Dashboard:</p>
            <ul>
                <li><code>PAYPAL_CLIENT_ID</code> - Your sandbox PayPal client ID</li>
                <li><code>PAYPAL_CLIENT_SECRET</code> - Your sandbox PayPal client secret</li>
                <li><code>PAYPAL_ENVIRONMENT</code> - "development"</li>
                <li><code>PAYPAL_WEBHOOK_ID</code> - Your webhook ID</li>
            </ul>
            <p>üß™ <strong>Test Credit Card Numbers:</strong></p>
            <ul>
                <li>Visa: <code>4111111111111111</code></li>
                <li>MasterCard: <code>5555555555554444</code></li>
                <li>American Express: <code>371449635398431</code></li>
                <li>CVV: <code>123</code> (Êàñ <code>1234</code> for AmEx)</li>
                <li>Expiry: Any future date (e.g., <code>12/25</code>)</li>
            </ul>
        </div>

        <!-- Test Environment Selector -->
        <div class="config">
            <h3>üéØ Test Environment</h3>
            <label>
                <input type="radio" name="environment" value="development" checked onclick="switchEnvironment('development')">
                Development (Sandbox)
            </label>
            <label style="margin-left: 20px;">
                <input type="radio" name="environment" value="production" onclick="switchEnvironment('production')">
                Production (Live)
            </label>
        </div>

        <!-- Test Navigation -->
        <div class="config">
            <h3>üß™ Test Sections</h3>
            <button onclick="showSection('basic-payment')" class="nav-button">Basic Payment</button>
            <button onclick="showSection('order-tracking')" class="nav-button">Order Tracking</button>
            <button onclick="showSection('payment-management')" class="nav-button">Payment Management</button>
            <button onclick="showSection('webhook-tests')" class="nav-button">Webhook Tests</button>
            <button onclick="showSection('api-explorer')" class="nav-button">API Explorer</button>
        </div>

        <!-- Basic Payment Section -->
        <div id="basic-payment" class="test-section active">
            <div class="product">
                <h3>üõçÔ∏è Basic Payment Test</h3>
                <p>Test basic PayPal payment functionality with SDK integration.</p>
                <div class="price">$<span id="price">10.00</span></div>
                
                <div class="input-group">
                    <label for="amount">Amount (USD):</label>
                    <input type="number" id="amount" value="10.00" min="1" step="0.01">
                </div>
                
                <div class="input-group">
                    <label for="currency">Currency:</label>
                    <select id="currency">
                        <option value="USD">USD</option>
                        <option value="EUR">EUR</option>
                        <option value="GBP">GBP</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="description">Description:</label>
                    <input type="text" id="description" value="Test Payment">
                </div>
                
                <!-- PayPal Buttons Container -->
                <div id="paypal-button-container"></div>
                
                <!-- Card Fields Container -->
                <div id="card-fields-container" style="margin-top: 20px;">
                    <h4>üí≥ Pay with Credit Card</h4>
                    <div id="card-name-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div id="card-number-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div id="card-expiry-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <div id="card-cvv-field-container" style="margin: 10px 0; padding: 10px; border: 1px solid #ccc; border-radius: 4px;"></div>
                    <button id="card-field-submit-button" style="margin-top: 10px; padding: 10px 20px; background: #0070ba; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Submit Payment
                    </button>
                </div>
                
                <!-- Manual test buttons -->
                <div class="api-form">
                    <h4>üîß Manual API Testing</h4>
                    <button id="pay-button" onclick="createPayPalOrder()">
                        üí≥ Create PayPal Order (Manual)
                    </button>
                </div>
            </div>
        </div>

        <!-- Order Tracking Section -->
        <div id="order-tracking" class="test-section">
            <div class="product">
                <h3>üì¶ Order Tracking Tests</h3>
                <p>Test order tracking, shipment tracking, and order management features.</p>
                
                <div class="api-form">
                    <h4>üîç Get Order Details</h4>
                    <input type="text" id="order-id-details" placeholder="Enter Order ID" class="order-id-input">
                    <button onclick="getOrderDetails()">Get Order Details</button>
                    <div id="order-details-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üöö Add Tracking Information</h4>
                    <input type="text" id="order-id-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <textarea id="tracking-data" class="json-input" placeholder='{"tracking_number": "1Z999AA1234567890", "carrier": "UPS", "tracking_url": "https://www.ups.com/track?tracknum=1Z999AA1234567890", "notify_buyer": true}'></textarea>
                    <button onclick="addOrderTracking()">Add Tracking Info</button>
                    <div id="tracking-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìã Get Tracking Information</h4>
                    <input type="text" id="order-id-get-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <button onclick="getOrderTracking()">Get Tracking Info</button>
                    <div id="get-tracking-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìù Update Tracking Information</h4>
                    <input type="text" id="order-id-update-tracking" placeholder="Enter Order ID" class="order-id-input">
                    <textarea id="update-tracking-data" class="json-input" placeholder='{"tracking_number": "1Z999AA1234567890", "carrier": "UPS", "status": "DELIVERED", "tracking_url": "https://www.ups.com/track?tracknum=1Z999AA1234567890", "notify_buyer": true}'></textarea>
                    <button onclick="updateOrderTracking()">Update Tracking Info</button>
                    <div id="update-tracking-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- Payment Management Section -->
        <div id="payment-management" class="test-section">
            <div class="product">
                <h3>üí∞ Payment Management Tests</h3>
                <p>Test payment details retrieval, refund processing, and payment monitoring.</p>
                
                <div class="api-form">
                    <h4>üîç Get Payment Details</h4>
                    <input type="text" id="payment-id-details" placeholder="Enter Payment ID" class="order-id-input">
                    <button onclick="getPaymentDetails()">Get Payment Details</button>
                    <div id="payment-details-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üí∏ Process Refund</h4>
                    <input type="text" id="payment-id-refund" placeholder="Enter Payment ID" class="order-id-input">
                    <textarea id="refund-data" class="json-input" placeholder='{"amount": "10.00", "currency": "USD", "note_to_payer": "Refund for order cancellation", "invoice_id": "INV-123"}'></textarea>
                    <button onclick="processRefund()">Process Refund</button>
                    <div id="refund-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- Webhook Tests Section -->
        <div id="webhook-tests" class="test-section">
            <div class="product">
                <h3>üîî Webhook Tests</h3>
                <p>Test webhook event handling and verification.</p>
                
                <div class="api-form">
                    <h4>‚úÖ Verify Webhook Signature</h4>
                    <textarea id="webhook-verification-data" class="json-input" placeholder='{"auth_algo": "SHA256withRSA", "cert_id": "cert_id", "transmission_id": "transmission_id", "transmission_sig": "signature", "transmission_time": "timestamp", "webhook_id": "webhook_id", "webhook_event": {}}'></textarea>
                    <button onclick="verifyWebhook()">Verify Webhook</button>
                    <div id="webhook-verify-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üß™ Simulate Webhook Events</h4>
                    <select id="webhook-event-type">
                        <option value="CHECKOUT.ORDER.APPROVED">CHECKOUT.ORDER.APPROVED</option>
                        <option value="CHECKOUT.ORDER.COMPLETED">CHECKOUT.ORDER.COMPLETED</option>
                        <option value="PAYMENT.CAPTURE.COMPLETED">PAYMENT.CAPTURE.COMPLETED</option>
                        <option value="PAYMENT.CAPTURE.DENIED">PAYMENT.CAPTURE.DENIED</option>
                        <option value="PAYMENT.CAPTURE.PENDING">PAYMENT.CAPTURE.PENDING</option>
                        <option value="PAYMENT.CAPTURE.REFUNDED">PAYMENT.CAPTURE.REFUNDED</option>
                        <option value="CUSTOMER.DISPUTE.CREATED">CUSTOMER.DISPUTE.CREATED</option>
                    </select>
                    <textarea id="webhook-event-data" class="json-input" placeholder='{"event_type": "PAYMENT.CAPTURE.COMPLETED", "resource": {"id": "payment_id", "amount": {"value": "10.00", "currency_code": "USD"}, "status": "COMPLETED"}}'></textarea>
                    <button onclick="simulateWebhookEvent()">Simulate Event</button>
                    <div id="webhook-simulate-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <!-- API Explorer Section -->
        <div id="api-explorer" class="test-section">
            <div class="product">
                <h3>üîß API Explorer</h3>
                <p>Test any API endpoint with custom parameters.</p>
                
                <div class="api-form">
                    <h4>üöÄ Custom API Call</h4>
                    <select id="api-method">
                        <option value="GET">GET</option>
                        <option value="POST">POST</option>
                        <option value="PUT">PUT</option>
                        <option value="DELETE">DELETE</option>
                    </select>
                    <input type="text" id="api-endpoint-input" placeholder="Enter endpoint (e.g., /orders/ORDER_ID)" class="order-id-input">
                    <textarea id="api-body" class="json-input" placeholder='{"key": "value"}'></textarea>
                    <button onclick="makeCustomAPICall()">Make API Call</button>
                    <div id="api-response" class="response-box"></div>
                </div>
                
                <div class="api-form">
                    <h4>üìä API Status Check</h4>
                    <button onclick="checkAPIStatus()">Check API Status</button>
                    <div id="api-status-response" class="response-box"></div>
                </div>
            </div>
        </div>

        <div id="status" class="status"></div>
        
        <div id="order-details" style="display: none;">
            <h3>üìÑ Order Details</h3>
            <pre id="order-json"></pre>
        </div>
    </div>

    <script>
        let API_BASE = 'https://paypal-payments-development.realharryscissors.workers.dev';
        let currentSection = 'basic-payment';
        
        // Environment switching
        function switchEnvironment(env) {
            if (env === 'production') {
                API_BASE = 'https://paypal-payments-production.realharryscissors.workers.dev';
            } else {
                API_BASE = 'https://paypal-payments-development.realharryscissors.workers.dev';
            }
            document.getElementById('api-endpoint').textContent = API_BASE;
            showStatus(`Switched to ${env} environment`, 'info');
        }
        
        // Section navigation
        function showSection(sectionId) {
            // Hide all sections
            document.querySelectorAll('.test-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Remove active class from all nav buttons
            document.querySelectorAll('.nav-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected section
            document.getElementById(sectionId).classList.add('active');
            
            // Add active class to clicked button
            event.target.classList.add('active');
            
            currentSection = sectionId;
        }
        
        // Test API connection on page load
        window.addEventListener('load', async () => {
            try {
                const response = await fetch(API_BASE);
                const data = await response.json();
                console.log('API Status:', data);
                
                if (data.service && data.environment) {
                    showStatus(`‚úÖ API Connected - Environment: ${data.environment}`, 'success');
                } else {
                    showStatus('‚ö†Ô∏è API Connected but unexpected response format', 'error');
                }
            } catch (error) {
                console.error('API Connection Error:', error);
                showStatus(`‚ùå API Connection Failed: ${error.message}`, 'error');
            }
        });
        
        function showStatus(message, type = 'info') {
            const statusEl = document.getElementById('status');
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
            statusEl.style.display = 'block';
        }
        
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        function updatePrice() {
            const amount = document.getElementById('amount').value;
            document.getElementById('price').textContent = parseFloat(amount).toFixed(2);
        }
        
        document.getElementById('amount').addEventListener('input', updatePrice);
        
        async function createPayPalOrder() {
            const payButton = document.getElementById('pay-button');
            const amount = document.getElementById('amount').value;
            const currency = document.getElementById('currency').value;
            const description = document.getElementById('description').value;
            
            if (!amount || amount <= 0) {
                showStatus('Please enter a valid amount', 'error');
                return;
            }
            
            payButton.disabled = true;
            payButton.textContent = 'Processing...';
            hideStatus();
            
            try {
                showStatus('Creating PayPal order...', 'info');
                
                const response = await fetch(`${API_BASE}/create-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: parseFloat(amount),
                        currency: currency,
                        description: description
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.links) {
                    showStatus('Order created successfully! Redirecting to PayPal...', 'success');
                    
                    // Show order details
                    document.getElementById('order-details').style.display = 'block';
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Find the approval URL
                    const approvalUrl = data.links.find(link => link.rel === 'approve');
                    if (approvalUrl) {
                        // Open PayPal approval page
                        window.open(approvalUrl.href, '_blank');
                        
                        // Show capture button
                        showCaptureButton(data.id);
                    } else {
                        showStatus('No approval URL found in response', 'error');
                    }
                } else {
                    showStatus(`Error: ${data.error || 'Failed to create order'}`, 'error');
                    console.error('PayPal order creation failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error creating PayPal order:', error);
            } finally {
                payButton.disabled = false;
                payButton.textContent = 'üí≥ Pay with PayPal';
            }
        }
        
        function showCaptureButton(orderId) {
            const existingButton = document.getElementById('capture-button');
            if (existingButton) {
                existingButton.remove();
            }
            
            const captureButton = document.createElement('button');
            captureButton.id = 'capture-button';
            captureButton.innerHTML = '‚úÖ Capture Payment';
            captureButton.onclick = () => capturePayPalOrder(orderId);
            captureButton.style.backgroundColor = '#28a745';
            captureButton.style.marginTop = '10px';
            
            document.querySelector('.product').appendChild(captureButton);
        }
        
        async function capturePayPalOrder(orderId) {
            const captureButton = document.getElementById('capture-button');
            captureButton.disabled = true;
            captureButton.textContent = 'Capturing...';
            
            try {
                showStatus('Capturing PayPal payment...', 'info');
                
                const response = await fetch(`${API_BASE}/capture-order`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        orderID: orderId
                    })
                });
                
                const data = await response.json();
                
                if (response.ok && data.status === 'COMPLETED') {
                    showStatus('Payment captured successfully! üéâ', 'success');
                    
                    // Update order details
                    document.getElementById('order-json').textContent = JSON.stringify(data, null, 2);
                    
                    // Remove capture button
                    captureButton.remove();
                } else {
                    showStatus(`Capture failed: ${data.error || 'Unknown error'}`, 'error');
                    console.error('PayPal capture failed:', data);
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
                console.error('Error capturing PayPal payment:', error);
            } finally {
                captureButton.disabled = false;
                captureButton.textContent = '‚úÖ Capture Payment';
            }
        }
        
        // Global variables
        let cardFields;
        let orderID;
        
        // Initialize PayPal Buttons
        function initializePayPalButtons() {
            // Clear existing buttons
            document.getElementById('paypal-button-container').innerHTML = '';
            
            paypal.Buttons({
                createOrder: function(data, actions) {
                    const amount = document.getElementById('amount').value;
                    const currency = document.getElementById('currency').value;
                    const description = document.getElementById('description').value;
                    
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    showStatus('Creating PayPal order...', 'info');
                    
                    return actions.order.create({
                        purchase_units: [{
                            amount: {
                                value: amount,
                                currency_code: currency
                            },
                            description: description
                        }]
                    });
                },
                
                onApprove: function(data, actions) {
                    showStatus('Payment approved! Capturing...', 'info');
                    
                    return actions.order.capture().then(function(details) {
                        showStatus('Payment completed successfully! üéâ', 'success');
                        
                        // Show order details
                        document.getElementById('order-details').style.display = 'block';
                        document.getElementById('order-json').textContent = JSON.stringify(details, null, 2);
                        
                        console.log('Payment completed:', details);
                        
                        // Also call our backend to record the transaction
                        recordTransaction(details);
                    });
                },
                
                onError: function(err) {
                    showStatus('Payment failed: ' + err.message, 'error');
                    console.error('PayPal error:', err);
                },
                
                onCancel: function(data) {
                    showStatus('Payment cancelled by user', 'error');
                    console.log('Payment cancelled:', data);
                }
            }).render('#paypal-button-container');
        }
        
        // Initialize Card Fields
        function initializeCardFields() {
            if (!paypal.CardFields) {
                showStatus('CardFields component not available', 'error');
                return;
            }
            
            // Check if eligible for CardFields
            if (!paypal.CardFields.isEligible()) {
                showStatus('CardFields not eligible for this merchant', 'error');
                document.getElementById('card-fields-container').style.display = 'none';
                return;
            }
            
            showStatus('CardFields component is eligible', 'success');
            
            cardFields = paypal.CardFields({
                createOrder: function() {
                    const amount = document.getElementById('amount').value;
                    const currency = document.getElementById('currency').value;
                    const description = document.getElementById('description').value;
                    
                    if (!amount || amount <= 0) {
                        showStatus('Please enter a valid amount', 'error');
                        return;
                    }
                    
                    showStatus('Creating order for card payment...', 'info');
                    
                    return fetch(`${API_BASE}/create-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            amount: parseFloat(amount),
                            currency: currency,
                            description: description
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(orderData) {
                        orderID = orderData.id;
                        return orderData.id;
                    });
                },
                
                onApprove: function(data) {
                    showStatus('Payment approved! Capturing...', 'info');
                    
                    return fetch(`${API_BASE}/capture-order`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            orderID: data.orderID
                        })
                    })
                    .then(function(response) {
                        return response.json();
                    })
                    .then(function(orderData) {
                        showStatus('Payment completed successfully! üéâ', 'success');
                        
                        // Show order details
                        document.getElementById('order-details').style.display = 'block';
                        document.getElementById('order-json').textContent = JSON.stringify(orderData, null, 2);
                        
                        console.log('Payment completed:', orderData);
                        
                        // Record transaction
                        recordTransaction(orderData);
                    });
                },
                
                onError: function(err) {
                    showStatus('Payment failed: ' + err.message, 'error');
                    console.error('CardFields error:', err);
                }
            });
            
            // Render card fields
            if (cardFields.NameField) {
                cardFields.NameField().render('#card-name-field-container');
            }
            
            if (cardFields.NumberField) {
                cardFields.NumberField().render('#card-number-field-container');
            }
            
            if (cardFields.ExpiryField) {
                cardFields.ExpiryField().render('#card-expiry-field-container');
            }
            
            if (cardFields.CVVField) {
                cardFields.CVVField().render('#card-cvv-field-container');
            }
            
            // Set up submit button
            document.getElementById('card-field-submit-button').addEventListener('click', function() {
                showStatus('Processing card payment...', 'info');
                
                cardFields.submit().then(function() {
                    showStatus('Card payment submitted successfully', 'success');
                }).catch(function(err) {
                    showStatus('Card payment failed: ' + err.message, 'error');
                    console.error('Card submit error:', err);
                });
            });
        }
        
        // Record transaction in our backend
        async function recordTransaction(details) {
            try {
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        event_type: 'PAYMENT.CAPTURE.COMPLETED',
                        resource: details
                    })
                });
                
                if (response.ok) {
                    console.log('Transaction recorded successfully');
                } else {
                    console.warn('Failed to record transaction');
                }
            } catch (error) {
                console.warn('Error recording transaction:', error);
            }
        }
        
        // Update buttons when amount or currency changes
        function updatePayPalButtons() {
            updatePrice();
            initializePayPalButtons();
        }
        
        // Update event listeners
        document.getElementById('amount').addEventListener('input', updatePayPalButtons);
        document.getElementById('currency').addEventListener('change', updatePayPalButtons);
        document.getElementById('description').addEventListener('input', updatePayPalButtons);
        
        // Initialize
        updatePrice();
        
        // Initialize PayPal components when page loads
        window.addEventListener('load', () => {
            // Wait a bit for PayPal SDK to load
            setTimeout(() => {
                if (typeof paypal !== 'undefined') {
                    initializePayPalButtons();
                    initializeCardFields();
                    showStatus('PayPal SDK loaded successfully', 'success');
                } else {
                    showStatus('PayPal SDK failed to load, showing manual buttons', 'error');
                    document.getElementById('manual-buttons').style.display = 'block';
                }
            }, 1000);
        });
        
        // ======================
        // NEW TESTING FUNCTIONS
        // ======================
        
        // Order Details Functions
        async function getOrderDetails() {
            const orderId = document.getElementById('order-id-details').value;
            if (!orderId) {
                showStatus('Please enter an Order ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching order details...', 'info');
                const response = await fetch(`${API_BASE}/orders/${orderId}`);
                const data = await response.json();
                
                document.getElementById('order-details-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Order details fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch order details'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        // Order Tracking Functions
        async function getOrderTracking() {
            const orderId = document.getElementById('order-id-get-tracking').value;
            if (!orderId) {
                showStatus('Please enter an Order ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching tracking information...', 'info');
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`);
                const data = await response.json();
                
                document.getElementById('get-tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function addOrderTracking() {
            const orderId = document.getElementById('order-id-tracking').value;
            const trackingData = document.getElementById('tracking-data').value;
            
            if (!orderId || !trackingData) {
                showStatus('Please enter both Order ID and tracking data', 'error');
                return;
            }
            
            try {
                const trackingJson = JSON.parse(trackingData);
                showStatus('Adding tracking information...', 'info');
                
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trackingJson)
                });
                
                const data = await response.json();
                document.getElementById('tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information added successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to add tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function updateOrderTracking() {
            const orderId = document.getElementById('order-id-update-tracking').value;
            const trackingData = document.getElementById('update-tracking-data').value;
            
            if (!orderId || !trackingData) {
                showStatus('Please enter both Order ID and tracking data', 'error');
                return;
            }
            
            try {
                const trackingJson = JSON.parse(trackingData);
                showStatus('Updating tracking information...', 'info');
                
                const response = await fetch(`${API_BASE}/orders/${orderId}/track`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(trackingJson)
                });
                
                const data = await response.json();
                document.getElementById('update-tracking-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Tracking information updated successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to update tracking information'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Payment Management Functions
        async function getPaymentDetails() {
            const paymentId = document.getElementById('payment-id-details').value;
            if (!paymentId) {
                showStatus('Please enter a Payment ID', 'error');
                return;
            }
            
            try {
                showStatus('Fetching payment details...', 'info');
                const response = await fetch(`${API_BASE}/payments/${paymentId}`);
                const data = await response.json();
                
                document.getElementById('payment-details-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Payment details fetched successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to fetch payment details'}`, 'error');
                }
            } catch (error) {
                showStatus(`Network error: ${error.message}`, 'error');
            }
        }
        
        async function processRefund() {
            const paymentId = document.getElementById('payment-id-refund').value;
            const refundData = document.getElementById('refund-data').value;
            
            if (!paymentId || !refundData) {
                showStatus('Please enter both Payment ID and refund data', 'error');
                return;
            }
            
            try {
                const refundJson = JSON.parse(refundData);
                showStatus('Processing refund...', 'info');
                
                const response = await fetch(`${API_BASE}/payments/${paymentId}/refund`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(refundJson)
                });
                
                const data = await response.json();
                document.getElementById('refund-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Refund processed successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to process refund'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Webhook Functions
        async function verifyWebhook() {
            const webhookData = document.getElementById('webhook-verification-data').value;
            
            if (!webhookData) {
                showStatus('Please enter webhook verification data', 'error');
                return;
            }
            
            try {
                const webhookJson = JSON.parse(webhookData);
                showStatus('Verifying webhook signature...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook/verify`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(webhookJson)
                });
                
                const data = await response.json();
                document.getElementById('webhook-verify-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('Webhook signature verified successfully', 'success');
                } else {
                    showStatus(`Error: ${data.error || 'Failed to verify webhook signature'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function simulateWebhookEvent() {
            const eventType = document.getElementById('webhook-event-type').value;
            const eventData = document.getElementById('webhook-event-data').value;
            
            if (!eventData) {
                showStatus('Please enter webhook event data', 'error');
                return;
            }
            
            try {
                const eventJson = JSON.parse(eventData);
                eventJson.event_type = eventType; // Override with selected event type
                
                showStatus('Simulating webhook event...', 'info');
                
                const response = await fetch(`${API_BASE}/webhook`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(eventJson)
                });
                
                const data = await response.text();
                document.getElementById('webhook-simulate-response').textContent = data;
                
                if (response.ok) {
                    showStatus('Webhook event simulated successfully', 'success');
                } else {
                    showStatus(`Error: Failed to simulate webhook event`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // API Explorer Functions
        async function makeCustomAPICall() {
            const method = document.getElementById('api-method').value;
            const endpoint = document.getElementById('api-endpoint-input').value;
            const body = document.getElementById('api-body').value;
            
            if (!endpoint) {
                showStatus('Please enter an API endpoint', 'error');
                return;
            }
            
            try {
                showStatus(`Making ${method} request to ${endpoint}...`, 'info');
                
                const requestOptions = {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };
                
                if (method !== 'GET' && body) {
                    requestOptions.body = body;
                }
                
                const response = await fetch(`${API_BASE}${endpoint}`, requestOptions);
                const data = await response.json();
                
                document.getElementById('api-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus(`${method} request completed successfully`, 'success');
                } else {
                    showStatus(`Error: ${data.error || 'API request failed'}`, 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        async function checkAPIStatus() {
            try {
                showStatus('Checking API status...', 'info');
                const response = await fetch(`${API_BASE}/`);
                const data = await response.json();
                
                document.getElementById('api-status-response').textContent = JSON.stringify(data, null, 2);
                
                if (response.ok) {
                    showStatus('API status check completed successfully', 'success');
                } else {
                    showStatus('API status check failed', 'error');
                }
            } catch (error) {
                showStatus(`Error: ${error.message}`, 'error');
            }
        }
        
        // Initialize first nav button as active
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelector('.nav-button').classList.add('active');
        });
    </script>
</body>
</html>